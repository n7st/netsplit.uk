<!doctype html><html lang=en><head><title>Remote Lab, Part 4: Configuring pfSense :: netsplit</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Part 1 (Introduction, OVH configuration.) Part 2 (Configuring Proxmox.) Part 3 (Installing pfSense.) Part 4 (Configuring pfSense. You&amp;rsquo;re here!)  Finally, we need to forward traffic from the WAN to internal VMs.
Connecting a virtual machine to the router Firstly, a new Proxmox virtual machine must be created. Ensure its network device is set to vmbr2 (which is configured as the OPT1 device in pfSense).
Setting up virtual IP addresses Virtual IPs are required for NAT."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://netsplit.uk/posts/2020/01/11/configuring_pfsense/><link rel=stylesheet href=https://netsplit.uk/assets/style.css><link rel=stylesheet href=https://netsplit.uk/assets/green.css><link rel=apple-touch-icon href=https://netsplit.uk/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://netsplit.uk/img/favicon/green.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Remote Lab, Part 4: Configuring pfSense"><meta property="og:description" content="Part 4: Configuring NAT and firewall rules in pfSense."><meta property="og:url" content="https://netsplit.uk/posts/2020/01/11/configuring_pfsense/"><meta property="og:site_name" content="netsplit"><meta property="og:image" content="https://netsplit.uk/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2020-01-11 12:29:20 +0000 UTC"></head><body class=green><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>netsplit</div></a></div><div class=menu-trigger>menu</div></div></header><div class=content><div class=post><h1 class=post-title><a href=https://netsplit.uk/posts/2020/01/11/configuring_pfsense/>Remote Lab, Part 4: Configuring pfSense</a></h1><div class=post-meta><span class=post-date>2020-01-11 [Updated: 2020-01-11]</span></div><span class=post-tags>#<a href=https://netsplit.uk/tags/remote-lab/>Remote Lab</a>&nbsp;
#<a href=https://netsplit.uk/tags/ovh/>OVH</a>&nbsp;
#<a href=https://netsplit.uk/tags/networking/>Networking</a>&nbsp;
#<a href=https://netsplit.uk/tags/pfsense/>pfSense</a>&nbsp;</span><div class=post-content><div><ul><li><a href=/posts/2019/02/13/remote_proxmox_lab_intro/>Part 1 (Introduction, OVH configuration.)</a></li><li><a href=/posts/2019/02/13/configuring_proxmox/>Part 2 (Configuring Proxmox.)</a></li><li><a href=/posts/2019/02/17/installing_pfsense/>Part 3 (Installing pfSense.)</a></li><li><a href=#>Part 4 (Configuring pfSense. You&rsquo;re here!)</a></li></ul><p>Finally, we need to forward traffic from the WAN to internal VMs.</p><h2 id=connecting-a-virtual-machine-to-the-router>Connecting a virtual machine to the router<a href=#connecting-a-virtual-machine-to-the-router class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Firstly, a new Proxmox virtual machine must be created. Ensure its network device
is set to <code>vmbr2</code> (which is configured as the OPT1 device in pfSense).</p><h2 id=setting-up-virtual-ip-addresses>Setting up virtual IP addresses<a href=#setting-up-virtual-ip-addresses class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Virtual IPs are required for NAT. <a href=https://docs.netgate.com/pfsense/en/latest/book/firewall/virtual-ip-addresses.html>Here is pfSense&rsquo;s official documentation</a>.</p><ol><li>From the &ldquo;Firewall&rdquo; menu, select &ldquo;Virtual IPs&rdquo;.</li><li>Add two new virtual IPs with the following settings:<ul><li>The internal IP address:<ul><li>Type: &ldquo;Proxy ARP&rdquo;</li><li>Interface: &ldquo;OPT1&rdquo;</li><li>Address type: &ldquo;Network&rdquo;</li><li>Address(es): &ldquo;10.5.4.2&rdquo; / &ldquo;32&rdquo; (single IPv4 address)</li><li>Description: Not parsed</li></ul></li><li>The external IP address:<ul><li>Type: &ldquo;Proxy ARP&rdquo;</li><li>Interface: &ldquo;WAN&rdquo;</li><li>Address type: &ldquo;Network&rdquo;</li><li>Address(es): &ldquo;5.39.60.71&rdquo; / &ldquo;32&rdquo; (single IPv4 address)</li><li>Description: Not parsed</li></ul></li></ul></li></ol><h2 id=configuring-11-nat>Configuring 1:1 NAT<a href=#configuring-11-nat class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Next, we will bind all traffic for the external IP to an internal IP address.</p><ol><li>From the &ldquo;Firewall&rdquo; menu, select &ldquo;NAT&rdquo;, and then &ldquo;1:1&rdquo;.</li><li>Add a new rule:<ul><li>Interface: &ldquo;WAN&rdquo;</li><li>External subnet IP: &ldquo;5.39.60.71&rdquo;</li><li>Internal IP: &ldquo;Single host&rdquo; &ldquo;10.5.4.2&rdquo;</li><li>Destination: &ldquo;Any&rdquo;</li><li>Description: Not parsed</li></ul></li></ol><p>This forwards all traffic sent to the external IP address (5.39.60.71) to the
internal VM (10.5.4.2).</p><h2 id=firewall-rules-to-permit-traffic-to-the-servers>Firewall rules to permit traffic to the servers<a href=#firewall-rules-to-permit-traffic-to-the-servers class=hanchor arialabel=Anchor>&#8983;</a></h2><p>For this example, the VM installed requires HTTP and HTTPS traffic to be allowed
to the VM, so we need two firewall rules on the WAN device.</p><ol><li>From the &ldquo;Firewall&rdquo; menu, select &ldquo;Rules&rdquo;.</li><li>Add two rules:<ul><li>HTTPS:<ul><li>Action: &ldquo;Pass&rdquo;</li><li>Interface: &ldquo;WAN&rdquo;</li><li>Address family: &ldquo;IPv4&rdquo;</li><li>Protocol: &ldquo;TCP&rdquo;</li><li>Source: &ldquo;Any&rdquo;</li><li>Destination: &ldquo;Single host or alias&rdquo; &ldquo;10.5.4.2&rdquo;</li><li>From: &ldquo;443&rdquo;</li><li>To: &ldquo;443&rdquo;</li><li>Description: Not parsed</li></ul></li><li>HTTP:<ul><li>Action: &ldquo;Pass&rdquo;</li><li>Interface: &ldquo;WAN&rdquo;</li><li>Address family: &ldquo;IPv4&rdquo;</li><li>Protocol: &ldquo;TCP&rdquo;</li><li>Source: &ldquo;Any&rdquo;</li><li>Destination: &ldquo;Single host or alias&rdquo; &ldquo;10.5.4.2&rdquo;</li><li>From: &ldquo;80&rdquo;</li><li>To: &ldquo;80&rdquo;</li><li>Description: Not parsed</li></ul></li></ul></li></ol><p>Further similar rules can be added for any other ports that need to be accessible
from the WAN.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://netsplit.uk/posts/2019/02/17/installing_pfsense/><span class=button__text>Remote Lab, Part 3: Installing pfSense</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2021 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://netsplit.uk/assets/main.js></script><script src=https://netsplit.uk/assets/prism.js></script></div></body></html>