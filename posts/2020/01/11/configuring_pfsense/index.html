<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Part 4: Configuring NAT and firewall rules in pfSense.
"><meta name=keywords content><meta name=robots content="noodp"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Remote Lab, Part 4: Configuring pfSense"><meta property="og:description" content="Part 4: Configuring NAT and firewall rules in pfSense.
"><meta property="og:url" content="https://netsplit.uk/posts/2020/01/11/configuring_pfsense/"><meta property="og:site_name" content="netsplit"><link rel=canonical href=https://netsplit.uk/posts/2020/01/11/configuring_pfsense/><link rel=stylesheet type=text/css href=/css/style.css><title>netsplit | Remote Lab, Part 4: Configuring pfSense</title></head><body><header><nav><ul><li><a href=/>Posts</a></li><li><a href=/about>About</a></li></ul></nav></header><div id=content><article><h1>Remote Lab, Part 4: Configuring pfSense</h1><aside><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#connecting-a-virtual-machine-to-the-router>Connecting a virtual machine to the router</a></li><li><a href=#setting-up-virtual-ip-addresses>Setting up virtual IP addresses</a></li><li><a href=#configuring-11-nat>Configuring 1:1 NAT</a></li><li><a href=#firewall-rules-to-permit-traffic-to-the-servers>Firewall rules to permit traffic to the servers</a></li></ul></nav><aside><p>This article was originally posted on Saturday, January 11, 2020.</p><ul><li><a href=/posts/2019/02/13/remote_proxmox_lab_intro/>Part 1 (Introduction, OVH configuration.)</a></li><li><a href=/posts/2019/02/13/configuring_proxmox/>Part 2 (Configuring Proxmox.)</a></li><li><a href=/posts/2019/02/17/installing_pfsense/>Part 3 (Installing pfSense.)</a></li><li><a href=#>Part 4 (Configuring pfSense. You&rsquo;re here!)</a></li></ul><p>Finally, we need to forward traffic from the WAN to internal VMs.</p><h2 id=connecting-a-virtual-machine-to-the-router>Connecting a virtual machine to the router <a href=#connecting-a-virtual-machine-to-the-router aria-label="Link to this heading">&#8983;</a></h2><p>Firstly, a new Proxmox virtual machine must be created. Ensure its network device
is set to <code>vmbr2</code> (which is configured as the OPT1 device in pfSense).</p><h2 id=setting-up-virtual-ip-addresses>Setting up virtual IP addresses <a href=#setting-up-virtual-ip-addresses aria-label="Link to this heading">&#8983;</a></h2><p>Virtual IPs are required for NAT. <a href=https://docs.netgate.com/pfsense/en/latest/book/firewall/virtual-ip-addresses.html>Here is pfSense&rsquo;s official documentation</a>.</p><ol><li>From the &ldquo;Firewall&rdquo; menu, select &ldquo;Virtual IPs&rdquo;.</li><li>Add two new virtual IPs with the following settings:<ul><li>The internal IP address:<ul><li>Type: &ldquo;Proxy ARP&rdquo;</li><li>Interface: &ldquo;OPT1&rdquo;</li><li>Address type: &ldquo;Network&rdquo;</li><li>Address(es): &ldquo;10.5.4.2&rdquo; / &ldquo;32&rdquo; (single IPv4 address)</li><li>Description: Not parsed</li></ul></li><li>The external IP address:<ul><li>Type: &ldquo;Proxy ARP&rdquo;</li><li>Interface: &ldquo;WAN&rdquo;</li><li>Address type: &ldquo;Network&rdquo;</li><li>Address(es): &ldquo;5.39.60.71&rdquo; / &ldquo;32&rdquo; (single IPv4 address)</li><li>Description: Not parsed</li></ul></li></ul></li></ol><h2 id=configuring-11-nat>Configuring 1:1 NAT <a href=#configuring-11-nat aria-label="Link to this heading">&#8983;</a></h2><p>Next, we will bind all traffic for the external IP to an internal IP address.</p><ol><li>From the &ldquo;Firewall&rdquo; menu, select &ldquo;NAT&rdquo;, and then &ldquo;1:1&rdquo;.</li><li>Add a new rule:<ul><li>Interface: &ldquo;WAN&rdquo;</li><li>External subnet IP: &ldquo;5.39.60.71&rdquo;</li><li>Internal IP: &ldquo;Single host&rdquo; &ldquo;10.5.4.2&rdquo;</li><li>Destination: &ldquo;Any&rdquo;</li><li>Description: Not parsed</li></ul></li></ol><p>This forwards all traffic sent to the external IP address (5.39.60.71) to the
internal VM (10.5.4.2).</p><h2 id=firewall-rules-to-permit-traffic-to-the-servers>Firewall rules to permit traffic to the servers <a href=#firewall-rules-to-permit-traffic-to-the-servers aria-label="Link to this heading">&#8983;</a></h2><p>For this example, the VM installed requires HTTP and HTTPS traffic to be allowed
to the VM, so we need two firewall rules on the WAN device.</p><ol><li>From the &ldquo;Firewall&rdquo; menu, select &ldquo;Rules&rdquo;.</li><li>Add two rules:<ul><li>HTTPS:<ul><li>Action: &ldquo;Pass&rdquo;</li><li>Interface: &ldquo;WAN&rdquo;</li><li>Address family: &ldquo;IPv4&rdquo;</li><li>Protocol: &ldquo;TCP&rdquo;</li><li>Source: &ldquo;Any&rdquo;</li><li>Destination: &ldquo;Single host or alias&rdquo; &ldquo;10.5.4.2&rdquo;</li><li>From: &ldquo;443&rdquo;</li><li>To: &ldquo;443&rdquo;</li><li>Description: Not parsed</li></ul></li><li>HTTP:<ul><li>Action: &ldquo;Pass&rdquo;</li><li>Interface: &ldquo;WAN&rdquo;</li><li>Address family: &ldquo;IPv4&rdquo;</li><li>Protocol: &ldquo;TCP&rdquo;</li><li>Source: &ldquo;Any&rdquo;</li><li>Destination: &ldquo;Single host or alias&rdquo; &ldquo;10.5.4.2&rdquo;</li><li>From: &ldquo;80&rdquo;</li><li>To: &ldquo;80&rdquo;</li><li>Description: Not parsed</li></ul></li></ul></li></ol><p>Further similar rules can be added for any other ports that need to be accessible
from the WAN.</p></article><aside><h2>Tags</h2><ul><li><a href=https://netsplit.uk/tags/remote-lab/>Remote Lab</a></li><li><a href=https://netsplit.uk/tags/ovh/>OVH</a></li><li><a href=https://netsplit.uk/tags/networking/>Networking</a></li><li><a href=https://netsplit.uk/tags/pfsense/>pfSense</a></li></ul></aside></div><footer><p>Copyright &copy; 2010-2022 Mike Jones</p></footer></body></html>