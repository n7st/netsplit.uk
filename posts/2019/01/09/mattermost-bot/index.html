<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This article provides a brief overview of how to set up a Mattermost chatbot
in Perl 5.
"><meta name=keywords content><meta name=robots content="noodp"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="How to build a Mattermost Chatbot in Perl"><meta property="og:description" content="This article provides a brief overview of how to set up a Mattermost chatbot
in Perl 5.
"><meta property="og:url" content="https://netsplit.uk/posts/2019/01/09/mattermost-bot/"><meta property="og:site_name" content="netsplit"><link rel=canonical href=https://netsplit.uk/posts/2019/01/09/mattermost-bot/><link rel=stylesheet type=text/css href=/css/style.css><title>netsplit | How to build a Mattermost Chatbot in Perl</title></head><body><header><nav><ul><li><a href=/>Posts</a></li><li><a href=/about>About</a></li></ul></nav></header><div id=content><article><h1>How to build a Mattermost Chatbot in Perl</h1><p>This article was originally posted on Wednesday, January 9, 2019 at 17:53:11.</p><h2 id=introduction>Introduction <a href=#introduction aria-label="Link to this heading">&#8983;</a></h2><p><a href=https://metacpan.org/pod/WebService::Mattermost>WebService::Mattermost</a> is an
alternative <a href=https://mattermost.com/>Mattermost</a> chatbot library written in
Perl. It provides two interfaces to the Mattermost API and WebSocket gateway:
from a script, and as a base for <a href=https://metacpan.org/pod/Moo>Moo</a> and
<a href=https://metacpan.org/pod/Moose>Moose</a> classes. In this article, I will cover
how to use it in a basic script, and demonstrate with a bot which greets users.</p><h2 id=requirements>Requirements <a href=#requirements aria-label="Link to this heading">&#8983;</a></h2><p>Installable from <a href=https://www.cpan.org/>CPAN</a>:</p><ul><li><a href=https://metacpan.org/pod/WebService::Mattermost><code>WebService::Mattermost</code></a>
(<a href=https://github.com/n7st/webservice-mattermost>source</a>)</li></ul><h2 id=final-code>Final code <a href=#final-code aria-label="Link to this heading">&#8983;</a></h2><p>For anyone who doesn&rsquo;t want to read, here is the final product. You will need to
change the authentication values in the constructor for
<a href=https://metacpan.org/pod/WebService::Mattermost::V4::Client><code>WebService::Mattermost::V4::Client</code></a>
to your own Mattermost server and bot user.</p><pre><code class=language-perl>#!/usr/bin/env perl

use strict;
use warnings;

use WebService::Mattermost::V4::Client;

my $bot = WebService::Mattermost::V4::Client-&gt;new({
    username =&gt; 'MATTERMOST USERNAME HERE',
    password =&gt; 'MATTERMOST PASSWORD HERE',
    base_url =&gt; 'https://my.mattermost-server.com/api/v4/',

    debug =&gt; 1, # Show extra connection information
});

# Triggered on every message received by the gateway
$bot-&gt;on(gw_message =&gt; sub {
    my ($bot, $args) = @_;

    # Only post-like messages contain post_data
    my $message = $args-&gt;{post_data}-&gt;{message};

    if ($message &amp;&amp; lc $message eq 'hello') {
        # Respond with a friendly greeting
        $bot-&gt;api-&gt;posts-&gt;create({
            message    =&gt; 'Hi, @'.$args-&gt;{message}-&gt;{data}-&gt;{sender_name},
            channel_id =&gt; $args-&gt;{post_data}-&gt;{channel_id},
        });
    }
});

# Start the bot
$bot-&gt;start();
</code></pre><h2 id=breakdown>Breakdown <a href=#breakdown aria-label="Link to this heading">&#8983;</a></h2><ul><li>First, as with all good Perl scripts, we need to enable strictures and
warnings.</li><li>Then, we instantiate the bot class with three required configuration values:<ul><li><code>username</code>: your Mattermost username (e.g. &ldquo;<a href=mailto:mybot@myemailaddress.org>mybot@myemailaddress.org</a>&rdquo;)</li><li><code>password</code>: your Mattermost password (e.g. &ldquo;hunter2&rdquo;)</li><li><code>base_url</code>: the base URL of your Mattermost server&rsquo;s API (e.g.
&ldquo;<a href=#>https://my.mattermost-server.com/api/v4/</a>&rdquo;)</li></ul></li></ul><pre><code class=language-perl>#!/usr/bin/env perl

use strict;
use warnings;

use WebService::Mattermost::V4::Client;

my $bot = WebService::Mattermost::V4::Client-&gt;new({
    username =&gt; 'MATTERMOST USERNAME HERE',
    password =&gt; 'MATTERMOST PASSWORD HERE',
    base_url =&gt; 'https://my.mattermost-server.com/api/v4/',

    debug =&gt; 1, # Show extra connection information
});
</code></pre><ul><li>Next, we add a non-blocking loop which watches for messages from the gateway.</li><li>Received messages include two arguments: <code>$bot</code>, which contains our instance
of <code>WebService::Mattermost::V4::Client</code>, and <code>$args</code>, which contains the
message from the gateway.</li></ul><pre><code class=language-perl># Triggered on every message received by the gateway
$bot-&gt;on(gw_message =&gt; sub {
    my ($bot, $args) = @_;

    # Only post-like messages contain post_data
    my $message = $args-&gt;{post_data}-&gt;{message};

    if ($message &amp;&amp; lc $message eq 'hello') {
        # Respond with a friendly greeting
        $bot-&gt;api-&gt;posts-&gt;create({
            message    =&gt; 'Hi, @'.$args-&gt;{message}-&gt;{data}-&gt;{sender_name},
            channel_id =&gt; $args-&gt;{post_data}-&gt;{channel_id},
        });
    }
});
</code></pre><ul><li>Finally, we start the bot.</li></ul><pre><code class=language-perl>$bot-&gt;start();
</code></pre><h2 id=extending>Extending <a href=#extending aria-label="Link to this heading">&#8983;</a></h2><p>In the bot&rsquo;s event loops, there are some additional utilites, accessible through
the <code>bot</code> argument:</p><ul><li><code>$bot->api</code>: a full Mattermost API integration
(<a href=https://metacpan.org/pod/WebService::Mattermost::V4::API>WebService::Mattermost::V4::API</a>)</li><li><code>$bot->ua</code>: an instance of <a href=https://metacpan.org/pod/Mojo::UserAgent>Mojo::UserAgent</a></li><li><code>$bot->logger</code>: an instance of <a href=https://metacpan.org/pod/Mojo::Log>Mojo::Log</a></li></ul></article><aside><h2>Tags</h2><ul><li><a href=https://netsplit.uk/tags/perl-5/>Perl 5</a></li><li><a href=https://netsplit.uk/tags/chatops/>Chatops</a></li><li><a href=https://netsplit.uk/tags/bot/>Bot</a></li><li><a href=https://netsplit.uk/tags/webservicemattermost/>WebService::Mattermost</a></li><li><a href=https://netsplit.uk/tags/tutorial/>Tutorial</a></li></ul></aside></div><footer><p>Copyright &copy; 2014-2022 Mike Jones</p></footer></body></html>