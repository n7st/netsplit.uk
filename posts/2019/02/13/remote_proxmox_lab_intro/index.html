<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Part 1: Set up a dedicated server with multiple IP addresses.
Build a remote lab with Proxmox and pfSense on an OVH dedicated server.
"><meta name=keywords content><meta name=robots content="noodp"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Remote Lab, Part 1: Pre-Installation Configuration"><meta property="og:description" content="Part 1: Set up a dedicated server with multiple IP addresses.
Build a remote lab with Proxmox and pfSense on an OVH dedicated server.
"><meta property="og:url" content="https://netsplit.uk/posts/2019/02/13/remote_proxmox_lab_intro/"><meta property="og:site_name" content="netsplit"><link rel=canonical href=https://netsplit.uk/posts/2019/02/13/remote_proxmox_lab_intro/><link rel=stylesheet type=text/css href=/css/style.css><title>netsplit | Remote Lab, Part 1: Pre-Installation Configuration</title></head><body><header><nav><ul><li><a href=/>Posts</a></li><li><a href=/about>About</a></li></ul></nav></header><div id=content><article><h1>Remote Lab, Part 1: Pre-Installation Configuration</h1><p>This article was originally posted on Wednesday, February 13, 2019.</p><ul><li><a href=#>Part 1 (Introduction, OVH configuration. You&rsquo;re here!)</a></li><li><a href=/posts/2019/02/13/configuring_proxmox/>Part 2 (Configuring Proxmox.)</a></li><li><a href=/posts/2019/02/17/installing_pfsense/>Part 3 (Installing pfSense.)</a></li><li><a href=/posts/2020/01/11/configuring_pfsense>Part 4 (Configuring pfSense.)</a></li></ul><h2 id=overview>Overview <a href=#overview aria-label="Link to this heading">&#8983;</a></h2><p>This guide details how to set up a remote lab with a
<a href=https://www.pfsense.org/>pfSense</a> gateway on an OVH dedicated server,
including basic firewall rules for managing access to the router&rsquo;s web
interface, and use of <a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a> for SSL
certificates.</p><p>First, we&rsquo;ll configure the server and its IP addresses.</p><h2 id=why>Why? <a href=#why aria-label="Link to this heading">&#8983;</a></h2><ul><li>Manage OVH&rsquo;s failover IP addresses in one place, rather than having to
manually set up the gateway on every single virtual machine.</li><li>Protect traffic to your virtual machines with one user-friendly firewall.</li><li>Use fewer IP addresses. Instead of having an address per machine, you can
forward ports to machines which do not have a public IP address.</li></ul><h2 id=requirements>Requirements <a href=#requirements aria-label="Link to this heading">&#8983;</a></h2><ol><li>An <a href=https://www.ovh.co.uk/>OVH</a> or <a href=https://www.soyoustart.com/en/>SoYouStart</a>
dedicated server. I am using a lower end SoYouStart server.</li><li>A domain name (and access to its DNS manager). In this example, I will use the
domain <code>example.com</code>.</li><li>Images for pfSense and (in this example) Ubuntu.</li></ol><h2 id=ovh-configuration>OVH configuration <a href=#ovh-configuration aria-label="Link to this heading">&#8983;</a></h2><h3 id=failover-ip-addresses>Failover IP addresses <a href=#failover-ip-addresses aria-label="Link to this heading">&#8983;</a></h3><p>OVH allow up to 16 extra free (after the initial setup fee) &ldquo;failover&rdquo; IP
addresses with their dedicated servers. These can be used to give a public IP
address to a virtual machine. For the sake of this guide, I have two failover IP
addresses: one for the router, and one for the first virtual machine, which I
will make publicly accessible.</p><ol><li>From the OVH control panel, select &ldquo;IP&rdquo;.</li><li>Select &ldquo;Order IPs&rdquo;.</li><li>Fill out the order form:<ul><li>Server: (choose your server&rsquo;s hostname)</li><li>Number of IPs: 1 address</li><li>Country: (your choice)</li><li>Accept the terms and conditions</li></ul></li><li>Repeat the process a second time for another IP address.</li></ol><p>You will shortly receive two e-mails with invoices. After paying, the orders can
take a while to fulfill. Once you receive confirmation that your addresses have
been set up, return to the IP management area to set up their virtual MAC
addresses.</p><ol><li>Select &ldquo;Manage IPs&rdquo;.</li><li>Select your server&rsquo;s hostname in the &ldquo;Service&rdquo; dropdown.</li><li>Click the &ldquo;settings&rdquo; icon (a cog) next to the first IP.</li><li>Select &ldquo;Add a virtual MAC&rdquo;.</li><li>Fill out the form:<ul><li>Name of VM: (this field is for display purposes only, so you can set the
name to whatever you like)</li><li>Type of virtual MAC: ovh</li><li>You want to: Create a new virtual MAC address</li></ul></li></ol><p>Next, set up the second failover IP address.</p><ol><li>Click the &ldquo;settings cog&rdquo; next to the second address.</li><li>Select &ldquo;Add a virtual MAC&rdquo;.</li><li>Set the VM name (this is required but can be anything).</li><li>Use the failover MAC address from the first failover IP.</li></ol><p>Again, fulfillment of the virtual MAC addresses can take a few minutes. You
won&rsquo;t receive an e-mail when they are finished, so check back later to find out.
After this, you should have a primary IP address with <strong>no</strong> virtual MAC
address, and two failover IP addresses with the <strong>same</strong> virtual MAC address.
The virtual MAC addresses should be the same because later on, we&rsquo;re going to
use a 1:1 NAT rule to route the second failover IP to a virtual machine. Any
further failover IP addresses added to the environment should also be
configured with the same virtual MAC address.</p><h2 id=ip-address-reference>IP address reference <a href=#ip-address-reference aria-label="Link to this heading">&#8983;</a></h2><p>For the rest of the guide, I will use the following (made up) examples:</p><table class="table table-bordered"><col style=width:15%><col style=width:15%><col style=width:15%><col style=width:auto><thead><tr><th>Name</th><th>IP Address</th><th>MAC Address</th><th>Description</th></tr></thead><tbody><tr><td>Primary</td><td>5.39.50.60</td><td>(none)</td><td>The IP address that was originally supplied with your server</td></tr><tr><td>Failover 1</td><td>5.39.60.70</td><td>02:01:01:e4:44:44</td><td>The IP address we'll use for pfSense's LAN interface</td></tr><tr><td>Failover 2</td><td>5.39.60.71</td><td>02:01:01:e4:44:44</td><td>The IP address we'll assign to the first virtual machine</td></tr></tbody></table><h3 id=ovh-gateway-ip-addresses>OVH gateway IP addresses <a href=#ovh-gateway-ip-addresses aria-label="Link to this heading">&#8983;</a></h3><p>Gateway addresses for OVH IP addresses are the address, but with the last octet
changed to <code>254</code>. This means that our primary IP address (ex. <code>5.39.50.60</code>)
becomes <code>5.39.50.254</code>. This is documented in greater detail
<a href=https://docs.ovh.com/gb/en/dedicated/network-bridging/#determine-the-gateway-address>in the OVH network bridge documentation</a>.</p><h3 id=subdomain-configuration>Subdomain configuration <a href=#subdomain-configuration aria-label="Link to this heading">&#8983;</a></h3><p>Later, we will need (well, <em>want</em>) subdomains for memorable access to the
services we&rsquo;re configuring. Add some A records using your DNS manager (replacing
my example names and addresses):</p><table class="table table-bordered"><col style=width:33.3%><col style=width:33.3%><col style=width:auto><thead><tr><th>Type</th><th>Name</th><th>IP address</th></tr></thead><tbody><tr><td>A</td><td>proxmox.example.com</td><td>5.39.50.60</td></tr><tr><td>A</td><td>pf.example.com</td><td>5.39.60.70</td></tr><tr><td>A</td><td>vm.example.com</td><td>5.39.60.71</td></tr></tbody></table><p>In the next part, we&rsquo;ll install and configure Proxmox on the dedicated server.</p><p><em><a href=/posts/2019/02/13/configuring_proxmox/>Read part 2</a></em></p></article><aside><h2>Tags</h2><ul><li><a href=https://netsplit.uk/tags/remote-lab/>Remote Lab</a></li><li><a href=https://netsplit.uk/tags/ovh/>OVH</a></li><li><a href=https://netsplit.uk/tags/networking/>Networking</a></li></ul></aside></div><footer><p>Copyright &copy; 2010-2022 Mike Jones</p></footer></body></html>